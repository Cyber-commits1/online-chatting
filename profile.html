<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Settings - Messenger</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Profile Page Specific Styles */
        .profile-page {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .profile-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
        }

        .back-btn {
            position: absolute;
            left: 20px;
            top: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .avatar-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }

        .avatar-large {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 5px solid white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            object-fit: cover;
            margin-bottom: 15px;
        }

        .avatar-upload-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .avatar-upload-btn:hover {
            background: white;
            color: #667eea;
        }

        .user-info-header {
            margin-top: 20px;
        }

        .user-info-header h1 {
            font-size: 32px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .user-info-header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .profile-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            min-height: 600px;
        }

        .profile-sidebar {
            background: #f8f9fa;
            padding: 30px 20px;
            border-right: 1px solid #dee2e6;
        }

        .nav-list {
            list-style: none;
            padding: 0;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 15px;
            color: #495057;
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .nav-link i {
            width: 30px;
            font-size: 18px;
            color: #667eea;
        }

        .nav-link:hover {
            background: #e9ecef;
            color: #495057;
        }

        .nav-link.active {
            background: #667eea;
            color: white;
        }

        .nav-link.active i {
            color: white;
        }

        .main-content {
            padding: 30px;
            overflow-y: auto;
            max-height: 600px;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f8f9fa;
        }

        .section-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: white;
            font-size: 18px;
        }

        .section-title {
            font-size: 22px;
            color: #343a40;
            font-weight: 600;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: white;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* Visibility Cards */
        .visibility-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .visibility-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #dee2e6;
            transition: all 0.3s;
            cursor: pointer;
        }

        .visibility-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .visibility-card.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .visibility-icon {
            font-size: 28px;
            color: #667eea;
            margin-bottom: 15px;
        }

        .visibility-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #343a40;
        }

        .visibility-desc {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .radio-options {
            margin-top: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            margin-right: 10px;
            accent-color: #667eea;
        }

        /* Theme Cards */
        .theme-cards {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .theme-card {
            flex: 1;
            min-width: 200px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #dee2e6;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .theme-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
        }

        .theme-card.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .theme-preview {
            width: 100%;
            height: 100px;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            position: relative;
        }

        .light-preview {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #dee2e6;
        }

        .dark-preview {
            background: linear-gradient(135deg, #212529 0%, #343a40 100%);
            border: 1px solid #495057;
        }

        .auto-preview {
            background: linear-gradient(to right, #ffffff 50%, #212529 50%);
            border: 1px solid #dee2e6;
        }

        .theme-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: #343a40;
        }

        .theme-desc {
            color: #6c757d;
            font-size: 14px;
        }

        /* Color Picker */
        .color-picker {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: white;
            box-shadow: 0 0 0 3px #667eea;
        }

        /* Toggle Switches */
        .toggle-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .toggle-group:hover {
            background: #e9ecef;
        }

        .toggle-info h4 {
            margin: 0 0 5px 0;
            color: #343a40;
        }

        .toggle-info p {
            margin: 0;
            color: #6c757d;
            font-size: 14px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #28a745;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            padding: 30px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .profile-content {
                grid-template-columns: 1fr;
            }
            
            .profile-sidebar {
                display: none;
            }
            
            .main-content {
                max-height: none;
                padding: 20px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Dark Mode Support */
        .dark-mode .profile-container {
            background: #2d3748;
        }

        .dark-mode .profile-sidebar {
            background: #4a5568;
            border-right-color: #718096;
        }

        .dark-mode .nav-link {
            color: #e2e8f0;
        }

        .dark-mode .nav-link:hover {
            background: #718096;
        }

        .dark-mode .section {
            background: #4a5568;
            border-color: #718096;
        }

        .dark-mode .section-title {
            color: #e2e8f0;
        }

        .dark-mode .form-control {
            background: #2d3748;
            border-color: #718096;
            color: #e2e8f0;
        }

        .dark-mode .form-control:focus {
            background: #2d3748;
        }

        .dark-mode .form-group label {
            color: #e2e8f0;
        }

        .dark-mode .visibility-card,
        .dark-mode .toggle-group {
            background: #2d3748;
            border-color: #718096;
        }

        .dark-mode .toggle-group:hover {
            background: #4a5568;
        }

        .dark-mode .toggle-info h4 {
            color: #e2e8f0;
        }

        .dark-mode .toggle-info p {
            color: #a0aec0;
        }

        .dark-mode .action-buttons {
            background: #4a5568;
            border-top-color: #718096;
        }
    </style>
</head>
<body class="light-mode">
    <div class="profile-page">
        <div class="profile-container">
            <!-- Header -->
            <div class="profile-header">
                <button class="back-btn" onclick="window.location.href='/dashboard'">
                    <i class="fas fa-arrow-left"></i>
                </button>
                
                <div class="avatar-section">
                    <img id="avatar-preview" class="avatar-large" src="" alt="Profile Avatar">
                    <input type="file" id="avatar-input" accept="image/*" style="display: none;">
                    <button class="avatar-upload-btn" onclick="document.getElementById('avatar-input').click()">
                        <i class="fas fa-camera"></i> Change Profile Picture
                    </button>
                </div>
                
                <div class="user-info-header">
                    <h1 id="profile-username">Loading...</h1>
                    <p id="profile-email">Loading...</p>
                </div>
            </div>

            <!-- Content -->
            <div class="profile-content">
                <!-- Sidebar -->
                <div class="profile-sidebar">
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a href="#" class="nav-link active" data-section="basic">
                                <i class="fas fa-user"></i>
                                <span>Basic Info</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-section="privacy">
                                <i class="fas fa-eye"></i>
                                <span>Privacy</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-section="theme">
                                <i class="fas fa-palette"></i>
                                <span>Theme</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-section="notifications">
                                <i class="fas fa-bell"></i>
                                <span>Notifications</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-section="security">
                                <i class="fas fa-shield-alt"></i>
                                <span>Security</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Main Content -->
                <div class="main-content" id="main-content">
                    <!-- Basic Info Section -->
                    <div class="section" id="basic-section">
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="fas fa-user"></i>
                            </div>
                            <h2 class="section-title">Basic Information</h2>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="bio">Bio</label>
                                <textarea id="bio" class="form-control" placeholder="Tell something about yourself..."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="phone">Phone Number</label>
                                <input type="tel" id="phone" class="form-control" placeholder="+998 90 123 45 67">
                            </div>
                            
                            <div class="form-group">
                                <label for="location">Location</label>
                                <input type="text" id="location" class="form-control" placeholder="City, Country">
                            </div>
                            
                            <div class="form-group">
                                <label for="website">Website</label>
                                <input type="url" id="website" class="form-control" placeholder="https://example.com">
                            </div>
                        </div>
                    </div>

                    <!-- Privacy Section -->
                    <div class="section" id="privacy-section" style="display: none;">
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="fas fa-eye"></i>
                            </div>
                            <h2 class="section-title">Privacy Settings</h2>
                        </div>
                        
                        <div class="visibility-cards">
                            <div class="visibility-card" data-type="onlineStatus">
                                <div class="visibility-icon">
                                    <i class="fas fa-circle"></i>
                                </div>
                                <div class="visibility-title">Online Status</div>
                                <div class="visibility-desc">Who can see when you're online</div>
                                <div class="radio-options">
                                    <label class="radio-option">
                                        <input type="radio" name="onlineStatus" value="public">
                                        <span>Everyone</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="onlineStatus" value="contacts">
                                        <span>Contacts Only</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="onlineStatus" value="private">
                                        <span>Nobody</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="visibility-card" data-type="lastSeen">
                                <div class="visibility-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="visibility-title">Last Seen</div>
                                <div class="visibility-desc">Who can see your last seen time</div>
                                <div class="radio-options">
                                    <label class="radio-option">
                                        <input type="radio" name="lastSeen" value="public">
                                        <span>Everyone</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="lastSeen" value="contacts">
                                        <span>Contacts Only</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="lastSeen" value="private">
                                        <span>Nobody</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="visibility-card" data-type="profileInfo">
                                <div class="visibility-icon">
                                    <i class="fas fa-info-circle"></i>
                                </div>
                                <div class="visibility-title">Profile Info</div>
                                <div class="visibility-desc">Who can see your bio, phone, location</div>
                                <div class="radio-options">
                                    <label class="radio-option">
                                        <input type="radio" name="profileInfo" value="public">
                                        <span>Everyone</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="profileInfo" value="contacts">
                                        <span>Contacts Only</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="profileInfo" value="private">
                                        <span>Nobody</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="visibility-card" data-type="avatar">
                                <div class="visibility-icon">
                                    <i class="fas fa-image"></i>
                                </div>
                                <div class="visibility-title">Profile Picture</div>
                                <div class="visibility-desc">Who can see your profile picture</div>
                                <div class="radio-options">
                                    <label class="radio-option">
                                        <input type="radio" name="avatar" value="public">
                                        <span>Everyone</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="avatar" value="contacts">
                                        <span>Contacts Only</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="avatar" value="private">
                                        <span>Nobody</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Theme Section -->
                    <div class="section" id="theme-section" style="display: none;">
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="fas fa-palette"></i>
                            </div>
                            <h2 class="section-title">Theme & Appearance</h2>
                        </div>
                        
                        <div class="theme-cards">
                            <div class="theme-card" data-theme="light">
                                <div class="theme-preview light-preview"></div>
                                <div class="theme-name">Light Mode</div>
                                <div class="theme-desc">Clean and bright interface</div>
                            </div>
                            
                            <div class="theme-card" data-theme="dark">
                                <div class="theme-preview dark-preview"></div>
                                <div class="theme-name">Dark Mode</div>
                                <div class="theme-desc">Easy on the eyes in low light</div>
                            </div>
                            
                            <div class="theme-card" data-theme="auto">
                                <div class="theme-preview auto-preview"></div>
                                <div class="theme-name">Auto</div>
                                <div class="theme-desc">Follows system settings</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <h3 style="color: #343a40; margin-bottom: 15px;">Accent Color</h3>
                            <div class="color-picker">
                                <div class="color-option selected" style="background-color: #667eea;" data-color="#667eea"></div>
                                <div class="color-option" style="background-color: #28a745;" data-color="#28a745"></div>
                                <div class="color-option" style="background-color: #dc3545;" data-color="#dc3545"></div>
                                <div class="color-option" style="background-color: #ffc107;" data-color="#ffc107"></div>
                                <div class="color-option" style="background-color: #6f42c1;" data-color="#6f42c1"></div>
                                <div class="color-option" style="background-color: #17a2b8;" data-color="#17a2b8"></div>
                                <div class="color-option" style="background-color: #fd7e14;" data-color="#fd7e14"></div>
                                <div class="color-option" style="background-color: #e83e8c;" data-color="#e83e8c"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Notifications Section -->
                    <div class="section" id="notifications-section" style="display: none;">
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="fas fa-bell"></i>
                            </div>
                            <h2 class="section-title">Notification Settings</h2>
                        </div>
                        
                        <div class="toggle-group">
                            <div class="toggle-info">
                                <h4>Message Notifications</h4>
                                <p>Receive notifications for new messages</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="notify-message" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="toggle-group">
                            <div class="toggle-info">
                                <h4>Call Notifications</h4>
                                <p>Receive notifications for calls</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="notify-call" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="toggle-group">
                            <div class="toggle-info">
                                <h4>Online Status Notifications</h4>
                                <p>Get notified when contacts come online</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="notify-online" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="toggle-group">
                            <div class="toggle-info">
                                <h4>Sound Effects</h4>
                                <p>Play sounds for notifications</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="sound-effects" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="toggle-group">
                            <div class="toggle-info">
                                <h4>Vibration</h4>
                                <p>Vibrate on notifications</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="vibration" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Security Section -->
                    <div class="section" id="security-section" style="display: none;">
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <h2 class="section-title">Privacy & Security</h2>
                        </div>
                        
                        <div class="toggle-group">
                            <div class="toggle-info">
                                <h4>Show Typing Indicator</h4>
                                <p>Let others see when you're typing</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="show-typing" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="toggle-group">
                            <div class="toggle-info">
                                <h4>Read Receipts</h4>
                                <p>Let others see when you've read their messages</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="read-receipts" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="form-group" style="margin-top: 20px;">
                            <label for="group-privacy">Who can add you to groups</label>
                            <select id="group-privacy" class="form-control">
                                <option value="everyone">Everyone</option>
                                <option value="contacts">Contacts Only</option>
                                <option value="nobody">Nobody</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="window.location.href='/dashboard'">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-primary" onclick="saveProfile()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
                <button class="btn btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let selectedColor = '#667eea';
        let selectedTheme = 'light';

        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/';
                return;
            }

            try {
                currentUser = JSON.parse(localStorage.getItem('user'));
                if (!currentUser) {
                    logout();
                    return;
                }

                await loadProfileData();
                setupEventListeners();
                setupNavigation();

                // Apply theme
                applyTheme();

            } catch (error) {
                console.error('Initialization error:', error);
                logout();
            }
        });

        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.section');
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Remove active class from all links
                    navLinks.forEach(l => l.classList.remove('active'));
                    
                    // Add active class to clicked link
                    link.classList.add('active');
                    
                    // Hide all sections
                    sections.forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    // Show selected section
                    const sectionId = link.dataset.section + '-section';
                    document.getElementById(sectionId).style.display = 'block';
                });
            });
        }

        async function loadProfileData() {
            try {
                document.getElementById('profile-username').textContent = currentUser.username;
                document.getElementById('profile-email').textContent = currentUser.email;
                document.getElementById('avatar-preview').src = currentUser.avatar || getDefaultAvatar(currentUser.username);

                const response = await fetch(`/api/user/${currentUser.id}/profile?currentUserId=${currentUser.id}`);
                const data = await response.json();

                if (data.success) {
                    const profile = data.profile;
                    
                    document.getElementById('bio').value = profile.bio || '';
                    document.getElementById('phone').value = profile.phone || '';
                    document.getElementById('location').value = profile.location || '';
                    document.getElementById('website').value = profile.website || '';

                    // Set visibility settings
                    if (profile.visibility) {
                        document.querySelector(`input[name="onlineStatus"][value="${profile.visibility.onlineStatus || 'public'}"]`).checked = true;
                        document.querySelector(`input[name="lastSeen"][value="${profile.visibility.lastSeen || 'public'}"]`).checked = true;
                        document.querySelector(`input[name="profileInfo"][value="${profile.visibility.profileInfo || 'public'}"]`).checked = true;
                        document.querySelector(`input[name="avatar"][value="${profile.visibility.avatar || 'public'}"]`).checked = true;
                    }

                    // Set theme settings
                    if (profile.theme) {
                        selectedTheme = profile.theme.mode || 'light';
                        selectedColor = profile.theme.primaryColor || '#667eea';
                        
                        document.querySelectorAll('.theme-card').forEach(card => {
                            card.classList.remove('selected');
                            if (card.dataset.theme === selectedTheme) {
                                card.classList.add('selected');
                            }
                        });
                        
                        document.querySelectorAll('.color-option').forEach(option => {
                            option.classList.remove('selected');
                            if (option.dataset.color === selectedColor) {
                                option.classList.add('selected');
                            }
                        });
                    }

                    // Set notification settings
                    if (profile.notifications) {
                        document.getElementById('notify-message').checked = profile.notifications.message !== false;
                        document.getElementById('notify-call').checked = profile.notifications.call !== false;
                        document.getElementById('notify-online').checked = profile.notifications.online !== false;
                        document.getElementById('sound-effects').checked = profile.notifications.sound !== false;
                        document.getElementById('vibration').checked = profile.notifications.vibration !== false;
                    }

                    // Set privacy settings
                    if (profile.privacy) {
                        document.getElementById('show-typing').checked = profile.privacy.showTyping !== false;
                        document.getElementById('read-receipts').checked = profile.privacy.readReceipts !== false;
                        document.getElementById('group-privacy').value = profile.privacy.groups || 'everyone';
                    }
                }
            } catch (error) {
                console.error('Error loading profile data:', error);
                showNotification('Failed to load profile data', 'error');
            }
        }

        function setupEventListeners() {
            document.getElementById('avatar-input').addEventListener('change', handleAvatarUpload);
            
            document.querySelectorAll('.theme-card').forEach(card => {
                card.addEventListener('click', function() {
                    selectedTheme = this.dataset.theme;
                    document.querySelectorAll('.theme-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    applyTheme();
                });
            });
            
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectedColor = this.dataset.color;
                    document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    applyTheme();
                });
            });
            
            document.querySelectorAll('.visibility-card').forEach(card => {
                const radioInputs = card.querySelectorAll('input[type="radio"]');
                radioInputs.forEach(input => {
                    input.addEventListener('change', function() {
                        card.classList.add('selected');
                    });
                });
            });
        }

        async function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showNotification('Please select an image file', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showNotification('Image size should be less than 5MB', 'error');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('avatar', file);
                formData.append('userId', currentUser.id);
                
                showNotification('Uploading avatar...', 'info');
                
                const response = await fetch('/api/upload-avatar', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('avatar-preview').src = data.avatarUrl;
                    currentUser.avatar = data.avatarUrl;
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    showNotification('Avatar updated successfully', 'success');
                } else {
                    showNotification('Failed to upload avatar', 'error');
                }
            } catch (error) {
                console.error('Error uploading avatar:', error);
                showNotification('Error uploading avatar', 'error');
            }
        }

        function applyTheme() {
            const root = document.documentElement;
            
            if (selectedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.body.classList.remove('light-mode');
            } else if (selectedTheme === 'light') {
                document.body.classList.add('light-mode');
                document.body.classList.remove('dark-mode');
            } else if (selectedTheme === 'auto') {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add('dark-mode');
                    document.body.classList.remove('light-mode');
                } else {
                    document.body.classList.add('light-mode');
                    document.body.classList.remove('dark-mode');
                }
            }
            
            root.style.setProperty('--primary-color', selectedColor);
            
            document.querySelectorAll('.btn-primary').forEach(btn => {
                btn.style.background = `linear-gradient(135deg, ${selectedColor} 0%, ${adjustColor(selectedColor, -30)} 100%)`;
            });
            
            document.querySelectorAll('.section-icon').forEach(icon => {
                icon.style.background = `linear-gradient(135deg, ${selectedColor} 0%, ${adjustColor(selectedColor, -30)} 100%)`;
            });
        }

        function adjustColor(color, amount) {
            let usePound = false;
            if (color[0] === "#") {
                color = color.slice(1);
                usePound = true;
            }
            const num = parseInt(color, 16);
            let r = (num >> 16) + amount;
            if (r > 255) r = 255;
            else if (r < 0) r = 0;
            let b = ((num >> 8) & 0x00FF) + amount;
            if (b > 255) b = 255;
            else if (b < 0) b = 0;
            let g = (num & 0x0000FF) + amount;
            if (g > 255) g = 255;
            else if (g < 0) g = 0;
            return (usePound ? "#" : "") + (g | (b << 8) | (r << 16)).toString(16).padStart(6, '0');
        }

        async function saveProfile() {
            try {
                const profileData = {
                    bio: document.getElementById('bio').value,
                    phone: document.getElementById('phone').value,
                    location: document.getElementById('location').value,
                    website: document.getElementById('website').value,
                    visibility: {
                        onlineStatus: document.querySelector('input[name="onlineStatus"]:checked').value,
                        lastSeen: document.querySelector('input[name="lastSeen"]:checked').value,
                        profileInfo: document.querySelector('input[name="profileInfo"]:checked').value,
                        avatar: document.querySelector('input[name="avatar"]:checked').value
                    },
                    notifications: {
                        message: document.getElementById('notify-message').checked,
                        call: document.getElementById('notify-call').checked,
                        online: document.getElementById('notify-online').checked,
                        sound: document.getElementById('sound-effects').checked,
                        vibration: document.getElementById('vibration').checked
                    },
                    theme: {
                        mode: selectedTheme,
                        primaryColor: selectedColor,
                        backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-color').trim(),
                        textColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim()
                    },
                    privacy: {
                        showTyping: document.getElementById('show-typing').checked,
                        readReceipts: document.getElementById('read-receipts').checked,
                        groups: document.getElementById('group-privacy').value
                    }
                };

                const response = await fetch('/api/profile/full', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        profile: profileData
                    })
                });

                const data = await response.json();

                if (data.success) {
                    currentUser = {
                        ...currentUser,
                        profile: profileData,
                        avatar: data.user.avatar || currentUser.avatar
                    };
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    
                    showNotification('Profile saved successfully', 'success');
                    
                    applyTheme();
                } else {
                    showNotification(data.error, 'error');
                }
            } catch (error) {
                console.error('Error saving profile:', error);
                showNotification('Failed to save profile', 'error');
            }
        }

        function getDefaultAvatar(username) {
            return `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=random&color=fff&bold=true`;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">&times;</button>
            `;
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideIn 0.3s ease;
            `;
            
            if (type === 'success') notification.style.background = '#28a745';
            else if (type === 'error') notification.style.background = '#dc3545';
            else if (type === 'info') notification.style.background = '#17a2b8';
            else if (type === 'warning') notification.style.background = '#ffc107';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        async function logout() {
            try {
                await fetch('/api/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ userId: currentUser.id })
                });
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/';
            }
        }
    </script>
</body>
</html>